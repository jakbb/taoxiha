package com.taoxiha.common.utils.log;import java.io.File;import java.util.HashMap;import java.util.Map;import org.apache.log4j.Layout;import org.apache.log4j.MDC;import org.apache.log4j.PatternLayout;import org.apache.log4j.RollingFileAppender;import org.apache.log4j.spi.LoggingEvent;import com.taoxiha.common.utils.date.DateUtils;import com.taoxiha.common.utils.io.FileHelper;import com.taoxiha.service.crawl.entity.CrawlInfoConfig;public class CrawlRollingFileAppender extends RollingFileAppender {   public static Map<String,RollingFileAppender> appenderCache = new HashMap<String,RollingFileAppender>();        private String taskNum;    	public CrawlRollingFileAppender(String taskNum) {		this.taskNum = taskNum;		appenderCache.put(taskNum,createAppender(taskNum));	}	public  RollingFileAppender getAppender(String taskNum) {		 RollingFileAppender appender = appenderCache.get(taskNum);  	       if(appender == null) {  	               appender = createAppender(taskNum);  	       appenderCache.put(taskNum,appender);  	           } 	       return appender;	}	@Override        public synchronized void doAppend(LoggingEvent event) {         RollingFileAppender appender = appenderCache.get(taskNum);         if(appender == null) {                 appender = createAppender(taskNum);         appenderCache.put(taskNum,appender);             }       String tasknum = (String) MDC.get("tasknum");	    if (taskNum.equals(tasknum)) {	      // 一个Appender对应一个tasknum，其他tasknum的event直接忽视	    	appender.doAppend(event);	    }   }         private  RollingFileAppender createAppender(String taskNum) {         RollingFileAppender result = new RollingFileAppender();       Layout layout = new PatternLayout("%m%n"); 		String datadir=CrawlInfoConfig.datapath+"/"+DateUtils.getTheDateString();		File file= new File(datadir,taskNum);		if(!file.isFile()){			file=FileHelper.mkdir(datadir,taskNum);		}       result.setLayout(layout);       result.setFile(file.getAbsolutePath());       activateOptions();       return  result;          } }